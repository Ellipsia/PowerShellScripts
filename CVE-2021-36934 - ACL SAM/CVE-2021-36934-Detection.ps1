## SAM ACL Check
# Checks for overly permissive ACLs on the SAM database folder at
# C:\Windows\System32\config\SAM
# u/jadodd | 20 Jul 8:37 AM | v0.1 - Initial Versions
# u/RobinBeismann | 28 Jul 9:34 PM | v0.2 - Changed the return behavior

#Variable to hold the exit code
$res = $null

$errors = @()

#Use icacls to query the target directory
$ACLs = $(icacls C:\Windows\System32\config\SAM)

#Check for the BUILTIN\Users ACL entry
if($ACLs -match "BUILTIN\\Users:\(I\)\(RX\)") {
    $errors += "Overly permissive BUILTIN\Users ACL found."
}

#Check for the All App Packages ACL
if($ACLs -match "APPLICATION PACKAGE AUTHORITY\\ALL APPLICATION PACKAGES:\(I\)\(RX\)") {
    $errors += "Overly permissive BUILTIN\Users ACL found."
}

#Check for the All Restricted App Packages ACL
if($ACLs -match "APPLICATION PACKAGE AUTHORITY\\ALL RESTRICTED APPLICATION PACKAGES:\(I\)\(RX\)") {
    $errors += "Overly permissive ALL RESTRICTED APPLICATION PACKAGES ACL found."
}

if($errors -and $errors.Count -gt 0){
	$res = $errors -join "; "
}

if ($res -eq $null){
    Exit 0
}
else {
    Exit 1
}